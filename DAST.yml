version: 0.2

env:
  secrets-manager:
    OwaspZapApiKey: dev/zap:apikey

  variables:
    OwaspZapURL: "http://10.0.7.152:8080"
    ApplicationURL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - apt-get install -y jq

pre_build:
  commands:
    - echo "=== OWASP ZAP SCAN START ==="

    - |
      echo "Target URL: $ApplicationURL"

    ###########################################################
    # ACTIVE SCAN
    ###########################################################
    - |
      SCAN_RESPONSE=$(curl -s "$OwaspZapURL/JSON/ascan/action/scan/?apikey=$OwaspZapApiKey&url=$ApplicationURL&recurse=true&inScopeOnly=false")
      echo "Scan API raw response: $SCAN_RESPONSE"
      scanid=$(echo "$SCAN_RESPONSE" | jq -r '.scan // empty')
      if [ -z "$scanid" ] || [ "$scanid" = "null" ]; then
        echo "❌ Failed to start active scan – no scan ID returned"
        exit 1
      fi
      echo "✅ Active Scan ID: $scanid"

    ###########################################################
    # ACTIVE SCAN PROGRESS LOOP (BOUNDED)
    ###########################################################
    - |
      stat=0
      attempts=0
      max_attempts=120   # ~10 minutes

      while [ "$stat" -lt 100 ] && [ "$attempts" -lt "$max_attempts" ]; do
        STATUS_RESPONSE=$(curl -s "$OwaspZapURL/JSON/ascan/view/status/?apikey=$OwaspZapApiKey&scanId=$scanid")
        stat=$(echo "$STATUS_RESPONSE" | jq -r '.status // 0')
        echo "Active Scan Progress: $stat% (attempt $attempts)"
        attempts=$((attempts + 1))
        sleep 5
      done

      if [ "$stat" -lt 100 ]; then
        echo "❌ Active scan did not finish within time limit"
        exit 1
      fi

      echo "=== Active Scan Completed ==="

    ###########################################################
    # FETCH HIGH & MEDIUM ALERTS
    ###########################################################
    - high_alerts=$(curl -s "$OwaspZapURL/JSON/alert/view/alertsSummary/?apikey=$OwaspZapApiKey&baseurl=$ApplicationURL" | jq -r '.alertsSummary.High // 0')
    - medium_alerts=$(curl -s "$OwaspZapURL/JSON/alert/view/alertsSummary/?apikey=$OwaspZapApiKey&baseurl=$ApplicationURL" | jq -r '.alertsSummary.Medium // 0')
    - |
      echo "High Alerts: $high_alerts"
      echo "Medium Alerts: $medium_alerts"


  build:
    commands:
      - mkdir -p dast-report

      ###########################################################
      # GENERATE RAW REPORTS
      ###########################################################
      - curl -s "$OwaspZapURL/OTHER/core/other/jsonreport/?apikey=$OwaspZapApiKey" -o dast-report/raw.json
      - curl -s "$OwaspZapURL/OTHER/core/other/htmlreport/?apikey=$OwaspZapApiKey" -o dast-report/raw.html

      ###########################################################
      # FILTER JSON → ONLY TARGET URL
      ###########################################################
      - jq --arg TARGET "$ApplicationURL" '.site |= map(select(.["@name"] | startswith($TARGET)))' dast-report/raw.json > dast-report/zap_report.json

      ###########################################################
      # FILTER HTML → ONLY TARGET URL (NO contains())
      ###########################################################
      - DOMAIN=$(echo "$ApplicationURL" | sed 's|https\?://||' | sed 's|/||g')
      - |
        awk "/<h2>.*$DOMAIN/ {flag=1}
             /<h2>/ && !/<h2>.*$DOMAIN/ {flag=0}
             flag" dast-report/raw.html > dast-report/zap_report.html

      - echo "=== Reports Generated ==="
      - ls -l dast-report

  post_build:
    commands:
      ###########################################################
      # FAIL IF HIGH OR MEDIUM ALERTS
      ###########################################################
      - |
        if [ "$high_alerts" != 0 ] || [ "$medium_alerts" != 0 ]; then
          echo "❌ High or Medium alerts found — failing build"
          exit 1
        fi

      - echo "✅ No High/Medium alerts — Build SUCCESS"

artifacts:
  files:
    - dast-report/**
  discard-paths: no
