version: 0.2

env:
  secrets-manager:
    ZAP_API_KEY: dev/zap:apikey
  variables:
    ZAP_URL: "http://10.0.7.152:8080"
    TARGET_URL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - echo "Setting up ZAP scan..."
      - apt-get update && apt-get install -y jq

  pre_build:
    commands:
      - echo "Testing ZAP connection..."
      - curl -s "${ZAP_URL}/JSON/core/view/version/?apikey=$ZAP_API_KEY" | jq .
      - |
        echo "Target: $TARGET_URL"

  build:
    commands:
      - |
        echo "Running ZAP scan using zap-api-scan.py..."
        cd /zap
        
        # Run the scan with comprehensive options
        python zap-api-scan.py \
          -t "$TARGET_URL" \
          -f html \
          -r zap-report.html \
          -x zap-report.xml \
          -J zap-report.json \
          -d \
          -z "-config api.key=$ZAP_API_KEY \
              -config connection.timeoutInSecs=600 \
              -config scanner.attackOnStart=true \
              -config scanner.threadPerHost=2" \
          -a \
          -j \
          -I
        
        # Check exit code
        SCAN_EXIT_CODE=$?
        echo "ZAP scan completed with exit code: $SCAN_EXIT_CODE"

  post_build:
    commands:
      - |
        echo "Processing results..."
        
        # List generated reports
        ls -la *.html *.json *.xml
        
        # Create summary
        echo "=== ZAP Scan Completed ==="
        echo "Reports generated:"
        find . -name "*.html" -o -name "*.json" -o -name "*.xml" | xargs ls -la

artifacts:
  files:
    - "*.html"
    - "*.json"
    - "*.xml"
  name: zap-security-reports

  artifacts:
  files:
    - '**/*'
  discard-paths: no