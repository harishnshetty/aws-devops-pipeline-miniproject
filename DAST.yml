version: 0.2

env:
  variables:
    # ZAP download details
    ZAP_VERSION: "2.16.1"
    # *** CHANGE: Using the .sh installer as requested ***
    ZAP_PROXY_URL: "https://github.com/zaproxy/zaproxy/releases/download/v2.16.1/ZAP_2_16_1_unix.sh"
    ZAP_INSTALLER_NAME: "ZAP_2_16_1_unix.sh"
    # The installer typically creates a directory named "ZAP_2.16.1" under the install path
    ZAP_INSTALL_DIR_NAME: "ZAP-2.16.1"

    # EFS (used for ZAP install + data cache)
    EFS_MOUNT_TARGET: "fs-0e6533aeea50371ed.efs.ap-south-1.amazonaws.com:/"
    EFS_MOUNT_DIR: "/efs"
    ZAP_SCAN_DATA_DIR: "/efs/zap-proxy" # This will be the parent directory for the install

    EFS_MOUNT_OPTIONS: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2,noresvport"
    RUN_DP_CHECK: "true"
    FAIL_ON_EFS_MOUNT: "false"
    FALLBACK_MANUAL_MOUNT: "false"
    MANUAL_MOUNT_MAX_RETRIES: "6"

phases:
  install:
    commands:
      - echo "===== install phase ====="
      - aws --version || true

  pre_build:
    commands:
      - echo "===== pre_build phase ====="
      - |
        # Install necessary dependencies
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update -y
          apt-get install -y jq curl unzip wget openjdk-17-jre nfs-common amazon-efs-utils python3 || true
        elif command -v yum >/dev/null 2>&1; then
          yum install -y jq curl unzip wget java-17-openjdk docker nfs-utils amazon-efs-utils python3 || true
        else
          echo "Ensure Java 17+, Python3, unzip, curl, wget, docker, and nfs client (amazon-efs-utils) are installed"
        fi

      # Local report dirs (for artifacts)
      - mkdir -p zap-report || true

      # EFS directories (for ZAP install/cache)
      - mkdir -p "$EFS_MOUNT_DIR" "$ZAP_SCAN_DATA_DIR" || true

      # EFS check & optional fallback manual mount (Unmodified EFS logic)
      - |
        echo "Checking EFS mountpoint: $EFS_MOUNT_DIR"
        if [ "$RUN_DP_CHECK" = "true" ]; then
          if mountpoint -q "$EFS_MOUNT_DIR"; then
            echo "EFS is mounted at $EFS_MOUNT_DIR."
          else
            echo "EFS not mounted at $EFS_MOUNT_DIR."
            if [ "${FALLBACK_MANUAL_MOUNT}" = "true" ]; then
              echo "Attempting manual mount ${EFS_MOUNT_TARGET} -> ${EFS_MOUNT_DIR}"
              MAX_RETRIES=${MANUAL_MOUNT_MAX_RETRIES:-6}
              COUNT=0
              MOUNT_SUCCESS=0
              while [ $COUNT -lt $MAX_RETRIES ]; do
                echo "Manual mount attempt $((COUNT+1))..."
                mount -v -t nfs4 -o ${EFS_MOUNT_OPTIONS} "${EFS_MOUNT_TARGET}" "${EFS_MOUNT_DIR}" && { MOUNT_SUCCESS=1; break; } || true
                COUNT=$((COUNT+1))
                sleep 10
              done
              if [ "$MOUNT_SUCCESS" -eq 1 ]; then
                echo "Manual mount succeeded."
              else
                echo "Manual mount failed after $MAX_RETRIES attempts."
                if [ "${FAIL_ON_EFS_MOUNT}" = "true" ]; then
                  echo "FAIL_ON_EFS_MOUNT=true -> failing build."
                  exit 1
                else
                  echo "Continuing without EFS; RUN_DP_CHECK will be disabled."
                  RUN_DP_CHECK="false"
                fi
              fi
            else
              if [ "${FAIL_ON_EFS_MOUNT}" = "true" ]; then
                echo "FAIL_ON_EFS_MOUNT=true and EFS not mounted -> failing build."
                exit 1
              else
                echo "Skipping Dependency-Check (EFS not mounted)."
                RUN_DP_CHECK="false"
              fi
            fi
          fi
        else
          echo "RUN_DP_CHECK != true â€” skipping EFS checks."
        fi

      # ZAP Preparation (Corrected to use the .sh installer script)
      - |
        echo "===== Preparing ZAP on EFS using ${ZAP_INSTALLER_NAME} ====="
        ZAP_INSTALLER_PATH="${ZAP_SCAN_DATA_DIR}/${ZAP_INSTALLER_NAME}"
        ZAP_INSTALL_ROOT_DIR="${ZAP_SCAN_DATA_DIR}"
        ZAP_INSTALL_DIR="${ZAP_INSTALL_ROOT_DIR}/${ZAP_INSTALL_DIR_NAME}"

        # 1) If ZAP already installed on EFS, just reuse it
        if [ -x "${ZAP_INSTALL_DIR}/zap.sh" ]; then
          echo "ZAP already installed at ${ZAP_INSTALL_DIR}, skipping download and installation."
        else
          # 2) If installer already cached on EFS, reuse it
          if [ -f "${ZAP_INSTALLER_PATH}" ]; then
            echo "Found existing ZAP installer in EFS: ${ZAP_INSTALLER_PATH}"
          else
            echo "ZAP installer not found in EFS, downloading..."
            curl -sSL "${ZAP_PROXY_URL}" -o "${ZAP_INSTALLER_PATH}"
          fi
          
          # Give execute permission and run the installer in silent mode
          echo "Running ZAP installer into ${ZAP_INSTALL_ROOT_DIR}..."
          chmod +x "${ZAP_INSTALLER_PATH}"
          # -q for silent mode, -dir to specify the installation directory
          "${ZAP_INSTALLER_PATH}" -q -dir "${ZAP_INSTALL_ROOT_DIR}"
          
          # The silent installer should create the ZAP-2.16.1 directory inside the specified root dir.
          if [ ! -d "${ZAP_INSTALL_DIR}" ]; then
              echo "FATAL ERROR: ZAP installation directory ${ZAP_INSTALL_DIR} was not created by the installer!"
              exit 1
          fi
        fi

        echo "ZAP is ready under: ${ZAP_INSTALL_DIR}"

  build:
    commands:
      - echo "===== build (ZAP Baseline Scan) phase ====="
      - TARGET_URL="https://staging.harishshetty.xyz/"
      - ZAP_INSTALL_DIR="${ZAP_SCAN_DATA_DIR}/${ZAP_INSTALL_DIR_NAME}"
      - REPORT_HTML="zap-report/zap_baseline.html"
      - REPORT_JSON="zap-report/zap_baseline.json"
      - echo "Running ZAP Baseline scan against ${TARGET_URL}"
      - |
        # The zap-baseline.py script is located inside the ZAP_INSTALL_DIR
        python3 "${ZAP_INSTALL_DIR}/zap-baseline.py" \
          -t "${TARGET_URL}" \
          -r "${REPORT_HTML}" \
          -J "${REPORT_JSON}" \
          -I \
          -m 2

artifacts:
  files:
    - zap-report/**
  discard-paths: no