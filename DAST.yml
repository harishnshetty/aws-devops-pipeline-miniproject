version: 0.2

env:
  secrets-manager:
    # Secret JSON format must be: {"apikey":"workshopzapapikey"}
    ZAP_API_KEY: dev/zap:apikey

  variables:
    ZAP_URL: "http://10.0.7.152:8080"     # Your ZAP daemon
    TARGET_URL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - echo "=== Install phase ==="
      - |
        if command -v yum >/dev/null 2>&1; then
          yum update -y
          yum install -y jq curl
        else
          apt-get update -y
          apt-get install -y jq curl
        fi

  pre_build:
    commands:
      - echo "=== Checking ZAP is reachable ==="
      - curl -s "$ZAP_URL/JSON/core/view/version/?apikey=$ZAP_API_KEY"
      - echo "=== Checking TARGET_URL is reachable from CodeBuild ==="
      - |
        curl -I $TARGET_URL || { echo "ERROR: Target not reachable"; exit 1; }
      - echo "=== Encoding URL ==="
      - ENCODED_TARGET=$(printf %s "$TARGET_URL" | jq -sRr @uri)
      - |
        echo "Encoded Target: $ENCODED_TARGET"

  build:
    commands:
      - echo "=== Starting Spider Scan on $TARGET_URL ==="
      - >
        SPIDER_SCAN_ID=$(curl -s \
        "$ZAP_URL/JSON/spider/action/scan/?apikey=$ZAP_API_KEY&url=$ENCODED_TARGET&recurse=true&subtreeOnly=false" \
        | jq -r '.scan')
      - |
        echo "Spider scan id: $SPIDER_SCAN_ID"

      - |
        STATUS=0
        while [ "$STATUS" -lt 100 ]; do
          STATUS=$(curl -s \
            "$ZAP_URL/JSON/spider/view/status/?scanId=$SPIDER_SCAN_ID" \
            | jq -r '.status')
          echo "Spider progress: $STATUS %"
          sleep 5
        done
      - echo "=== Spider Completed ==="

      - echo "=== Starting Active Scan on $TARGET_URL ==="
      - >
        ASCAN_ID=$(curl -s \
        "$ZAP_URL/JSON/ascan/action/scan/?apikey=$ZAP_API_KEY&url=$ENCODED_TARGET&recurse=true&inScopeOnly=false" \
        | jq -r '.scan')
      - |
        echo "Active scan id: $ASCAN_ID"

      - |
        ASTATUS=0
        while [ "$ASTATUS" -lt 100 ]; do
          ASTATUS=$(curl -s \
            "$ZAP_URL/JSON/ascan/view/status/?scanId=$ASCAN_ID" \
            | jq -r '.status')
          echo "Active scan progress: $ASTATUS %"
          sleep 10
        done
      - echo "=== Active Scan Completed ==="

      - echo "=== Generating DAST Reports ==="
      - mkdir -p dast-report
      - curl -s "$ZAP_URL/OTHER/core/other/htmlreport/?apikey=$ZAP_API_KEY" -o dast-report/zap_report.html
      - curl -s "$ZAP_URL/OTHER/core/other/jsonreport/?apikey=$ZAP_API_KEY" -o dast-report/zap_report.json
      - echo "Report files:"
      - ls -l dast-report

      - echo "=== Checking ZAP scanned correct TARGET_URL ==="
      - curl -s "$ZAP_URL/JSON/core/view/sites/" | jq

  post_build:
    commands:
      - echo "=== Checking High Alerts ==="
      - >
        HIGH_COUNT=$(jq '[.site[].alerts[] | select(.riskcode=="3")] | length' \
        dast-report/zap_report.json)
      - |
        echo "High alerts found: $HIGH_COUNT"

      - |
        if [ "$HIGH_COUNT" -gt 0 ]; then
          echo "❌ Build failed: High risk alerts found."
          exit 1
        fi
        echo "✅ No High alerts, build passed."

artifacts:
  files:
    - dast-report/**
  discard-paths: no
