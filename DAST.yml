version: 0.2

env:
  secrets-manager:
    ZAP_API_KEY: dev/zap:apikey   # your secret/key
  variables:
    ZAP_HOST: "10.0.7.152"
    ZAP_PORT: "8080"
    TARGET_URL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - apt-get update -y
      - apt-get install -y jq curl

  build:
    commands:
      - |
        set -e
        ZAP_URL="http://$ZAP_HOST:$ZAP_PORT"
        TARGET="$TARGET_URL"
        API_KEY="$ZAP_API_KEY"

        echo "ZAP_URL = $ZAP_URL"
        echo "TARGET  = $TARGET"

        echo "=== 1) New session ==="
        curl -s "$ZAP_URL/JSON/core/action/newSession/?apikey=$API_KEY&name=codebuild_dast&overwrite=true" > /tmp/zap_newsession.json || true
        cat /tmp/zap_newsession.json || true

        echo "=== 2) Spider ==="
        SPIDER_JSON=$(curl -s "$ZAP_URL/JSON/spider/action/scan/?apikey=$API_KEY&url=$TARGET&recurse=true")
        echo "Spider response: $SPIDER_JSON"
        SPIDER_ID=$(echo "$SPIDER_JSON" | jq -r '.scan')
        echo "Spider id: $SPIDER_ID"

        if [ "$SPIDER_ID" = "null" ] || [ -z "$SPIDER_ID" ]; then
          echo "❗ Spider scan did not start correctly (scan id is null/empty)."
        else
          while true; do
            STATUS=$(curl -s "$ZAP_URL/JSON/spider/view/status/?apikey=$API_KEY&scanId=$SPIDER_ID" | jq -r '.status')
            echo "Spider progress: $STATUS%"
            if [ "$STATUS" != "null" ] && [ "$STATUS" -ge 100 ]; then
              break
            fi
            sleep 5
          done

          echo "Spider done, sleeping 5s..."
          sleep 5
        fi

        echo "=== 2.5) Get Sites from ZAP tree ==="
        SITES_JSON=$(curl -s "$ZAP_URL/JSON/core/view/sites/?apikey=$API_KEY")
        echo "Sites JSON: $SITES_JSON"
        # Extract list of sites
        SITES=$(echo "$SITES_JSON" | jq -r '.sites[]')
        echo "Sites in ZAP tree:"
        echo "$SITES"

        # Try to pick a site that contains our hostname
        SCAN_URL=$(echo "$SITES" | grep 'staging.harishshetty.xyz' | head -n1 || true)

        if [ -z "$SCAN_URL" ]; then
          echo "❗ Could not find staging.harishshetty.xyz in sites list, falling back to TARGET"
          SCAN_URL="$TARGET"
        fi

        echo "Using scan URL: $SCAN_URL"

        echo "=== 3) Active Scan ==="
        ASCAN_JSON=$(curl -s "$ZAP_URL/JSON/ascan/action/scan/?apikey=$API_KEY&url=$SCAN_URL&recurse=true&inScopeOnly=false")
        echo "Active scan response: $ASCAN_JSON"
        SCAN_ID=$(echo "$ASCAN_JSON" | jq -r '.scan')
        echo "Scan id: $SCAN_ID"

        if [ "$SCAN_ID" = "null" ] || [ -z "$SCAN_ID" ]; then
          echo "❗ Active scan did not start properly (scan id is null/empty). Skipping active scan loop."
        else
          while true; do
            STATUS=$(curl -s "$ZAP_URL/JSON/ascan/view/status/?apikey=$API_KEY&scanId=$SCAN_ID" | jq -r '.status')
            echo "Active scan progress: $STATUS%"
            if [ "$STATUS" != "null" ] && [ "$STATUS" -ge 100 ]; then
              break
            fi
            sleep 10
          done
        fi

        echo "=== 4) Reports ==="
        # HTML report for everything in current session
        curl -s "$ZAP_URL/OTHER/core/other/htmlreport/?apikey=$API_KEY" > zap_report.html

        # JSON alerts for the specific site URL from tree
        curl -s "$ZAP_URL/JSON/core/view/alerts/?apikey=$API_KEY&baseurl=$SCAN_URL" > zap_report.json

artifacts:
  files:
    - zap_report.html
    - zap_report.json
