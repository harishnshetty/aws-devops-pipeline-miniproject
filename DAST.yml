version: 0.2

env:
  secrets-manager:
    OwaspZapApiKey: dev/zap:apikey

  variables:
    OwaspZapURL: "http://10.0.7.152:8080"
    ApplicationURL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - apt-get install -y jq

  pre_build:
    commands:
      - |
      - echo "=== OWASP ZAP SCAN START ==="
      - ENCODED_URL=$(printf %s "$ApplicationURL" | jq -sRr @uri)
      - echo "Target URL: $ApplicationURL"
      - echo "Encoded URL: $ENCODED_URL"

      ###########################################################
      # ACTIVE SCAN
      ###########################################################
      - scanid=$(curl -s "$OwaspZapURL/JSON/ascan/action/scan/?apikey=$OwaspZapApiKey&url=$ENCODED_URL&recurse=true&inScopeOnly=false" | jq -r '.scan')
      - echo "Active Scan ID: $scanid"

      ###########################################################
      # ACTIVE SCAN PROGRESS LOOP
      ###########################################################
      - |
        stat=0
        while [ "$stat" -lt 100 ]; do
          stat=$(curl -s "$OwaspZapURL/JSON/ascan/view/status/?apikey=$OwaspZapApiKey&scanId=$scanid" | jq -r '.status // 0')
          echo "Active Scan Progress: $stat%"
          sleep 5
        done
        echo "=== Active Scan Completed ==="

      ###########################################################
      # FETCH HIGH & MEDIUM ALERTS
      ###########################################################
      - high_alerts=$(curl -s "$OwaspZapURL/JSON/alert/view/alertsSummary/?apikey=$OwaspZapApiKey&baseurl=$ApplicationURL" | jq -r '.alertsSummary.High // 0')
      - medium_alerts=$(curl -s "$OwaspZapURL/JSON/alert/view/alertsSummary/?apikey=$OwaspZapApiKey&baseurl=$ApplicationURL" | jq -r '.alertsSummary.Medium // 0')
        |
      - echo "High Alerts: $high_alerts"
      - echo "Medium Alerts: $medium_alerts"

  build:
    commands:
      - mkdir -p dast-report

      ###########################################################
      # GENERATE RAW REPORTS
      ###########################################################
      - curl -s "$OwaspZapURL/OTHER/core/other/jsonreport/?apikey=$OwaspZapApiKey" -o dast-report/raw.json
      - curl -s "$OwaspZapURL/OTHER/core/other/htmlreport/?apikey=$OwaspZapApiKey" -o dast-report/raw.html

      ###########################################################
      # FILTER JSON → ONLY TARGET URL
      ###########################################################
      - jq --arg TARGET "$ApplicationURL" '.site |= map(select(.["@name"] | startswith($TARGET)))' dast-report/raw.json > dast-report/zap_report.json

      ###########################################################
      # FILTER HTML → ONLY TARGET URL (NO contains())
      ###########################################################
      - DOMAIN=$(echo "$ApplicationURL" | sed 's|https\?://||' | sed 's|/||g')
      - |
        awk "/<h2>.*$DOMAIN/ {flag=1}
             /<h2>/ && !/<h2>.*$DOMAIN/ {flag=0}
             flag" dast-report/raw.html > dast-report/zap_report.html

      - echo "=== Reports Generated ==="
      - ls -l dast-report

  post_build:
    commands:
      ###########################################################
      # FAIL IF HIGH OR MEDIUM ALERTS
      ###########################################################
      - |
        if [ "$high_alerts" != 0 ] || [ "$medium_alerts" != 0 ]; then
          echo "❌ High or Medium alerts found — failing build"
          exit 1
        fi

      - echo "✅ No High/Medium alerts — Build SUCCESS"

artifacts:
  files:
    - dast-report/**
  discard-paths: no
