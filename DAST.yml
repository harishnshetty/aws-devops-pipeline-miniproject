version: 0.2

env:
  secrets-manager:
    ZAP_API_KEY: dev/zap:apikey

  variables:
    ZAP_URL: "http://10.0.7.152:8080"
    TARGET_URL: "https://staging.harishshetty.xyz/"

phases:
  install:
    commands:
      - echo "=== INSTALL PHASE ==="
      - yum install -y jq || apt-get install -y jq

  pre_build:
    commands:
        |
      - echo "=== Checking ZAP Daemon ==="
      - curl -s "$ZAP_URL/JSON/core/view/version/?apikey=$ZAP_API_KEY"

      - echo "=== Checking Target Website Access ==="
      - curl -I "$TARGET_URL"

      - echo "=== Encoding Target URL ==="
      - ENCODED_TARGET=$(printf %s "$TARGET_URL" | jq -sRr @uri)
      - echo "Encoded Target: $ENCODED_TARGET"

  build:
    commands:
      ##############################################################
      # SPIDER SCAN
      ##############################################################
      - echo "=== Starting Spider ==="
      - SPIDER_SCAN_ID=$(curl -s "$ZAP_URL/JSON/spider/action/scan/?apikey=$ZAP_API_KEY&url=$ENCODED_TARGET&recurse=true" | jq -r '.scan')
      - |
        echo "Spider ID: $SPIDER_SCAN_ID"

      - |
        STATUS=0
        while [ "$STATUS" -lt 100 ]; do
          STATUS=$(curl -s "$ZAP_URL/JSON/spider/view/status/?scanId=$SPIDER_SCAN_ID" | jq -r '.status // 0')
          echo "Spider progress: $STATUS %"
          sleep 5
        done

      ##############################################################
      # ACTIVE SCAN
      ##############################################################
      - echo "=== Starting Active Scan ==="
      - ASCAN_ID=$(curl -s "$ZAP_URL/JSON/ascan/action/scan/?apikey=$ZAP_API_KEY&url=$ENCODED_TARGET&recurse=true&inScopeOnly=false" | jq -r '.scan')
      - |
        echo "Active Scan ID: $ASCAN_ID"

      - |
        ASTATUS=0
        while [ "$ASTATUS" -lt 100 ]; do
          ASTATUS=$(curl -s "$ZAP_URL/JSON/ascan/view/status/?scanId=$ASCAN_ID" | jq -r '.status // 0')
          echo "Active Scan progress: $ASTATUS %"
          sleep 8
        done

      ##############################################################
      # DOWNLOAD RAW REPORTS
      ##############################################################
      - echo "=== Downloading Reports ==="
      - mkdir -p dast-report
      - curl -s "$ZAP_URL/OTHER/core/other/htmlreport/?apikey=$ZAP_API_KEY" -o dast-report/raw.html
      - curl -s "$ZAP_URL/OTHER/core/other/jsonreport/?apikey=$ZAP_API_KEY" -o dast-report/raw.json

      ##############################################################
      # FILTER JSON (ONLY TARGET URL)
      ##############################################################
      - echo "=== Filtering JSON (Target Only) ==="
      - jq --arg TARGET "$TARGET_URL" '.site |= map(select(.["@name"] | startswith($TARGET)))' dast-report/raw.json > dast-report/zap_report.json

      ##############################################################
      # FILTER HTML (ONLY TARGET URL)
      ##############################################################
      - echo "=== Filtering HTML (Target Only) ==="
      - DOMAIN=$(echo "$TARGET_URL" | sed 's|https\?://||' | sed 's|/||g')

      # Extract only the <h2> section for TARGET_URL
      - |
        awk "/<h2>.*$DOMAIN/ {flag=1} 
             /<h2>/ && !/<h2>.*$DOMAIN/ {flag=0} 
             flag" dast-report/raw.html > dast-report/zap_report.html

      - echo "=== Final Reports Generated ==="
      - ls -l dast-report

  post_build:
    commands:
        |
      - echo "=== Checking High Alerts ==="
      - HIGH=$(jq '[.site[].alerts[] | select(.riskcode=="3")] | length' dast-report/zap_report.json)
      - echo "High Alerts Found: $HIGH"
      - |
        if [ "$HIGH" -gt 0 ]; then
          echo "❌ High alerts found — Failing build."
          exit 1
        fi
        echo "✅ No high alerts — Build OK."

artifacts:
  files:
    - dast-report/**
  discard-paths: no
